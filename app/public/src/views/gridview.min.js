PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.scale=1,this._super(),this.dontZoom=!1,this.numMissing=0;var a=this;$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(a.isActive){if(a.dontZoom)return void(a.dontZoom=!1);var c=a.scale,f=(a.currentWidth,a.currentHeight,void 0!=b.scale?0:1e3);void 0!=b.scale?b.scale>=1?a.scale+=b.scale-1:(a.scale-=b.scale,a.scale=a.scale<1?1:a.scale):void 0!=b.delta&&(a.scale=0==b.delta?1:a.scale+b.delta),isNaN(a.scale)&&(a.scale=1);var g=(a.width-a.offsetX)*a.scale;if(g<a.width||1==a.scale?(a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.scale=1,a.dontZoom=!0,PV.zoom(0),a.recalibrateUISettings()):(a.currentOffsetX=b.x-(b.x-a.currentOffsetX)/c*a.scale,a.currentOffsetY=b.y-(b.y-a.currentOffsetY)/c*a.scale,a.currentWidth=g,a.currentHeight=(a.height-a.offsetY)*a.scale,a.recalibrateUISettings()),a.setTilePositions(a.rowscols,a.filterList,a.currentOffsetX,a.currentOffsetY,!0,!0,f),1==a.scale&&1!=c){for(var h=0;h<a.tiles.length;h++)a.tiles[h].setSelected(!1);a.selected=null,$.publish("/PivotViewer/Views/Item/Selected",[{item:a.selected,bkt:0}])}}})},resetUISettings:function(){this.rowscols=this.calculateDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing)},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.maxRatio,this.filterList.length-this.numMissing,this.rowscols)},setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.maxRatio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},activate:function(){var a=this;if(Modernizr.canvas){this._super();for(var b=0;b<this.tiles.length;b++)this.tiles[b]._locations=[this.tiles[b]._locations[0]];for(var c=0;c<this.tiles.length;c++)this.tiles[c].selectedLoc=0;var d=0,e=$(".pv-toolbarpanel-zoomslider").slider("option","value");if(e>0){this.selected=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0),this.resetUISettings();for(var c=0;c<this.filterList.length;c++){var f=this.filterList[c];f.origwidth=this.rowscols.TileHeight/TileController._imageController.getRatio(f.item.img),f.origheight=this.rowscols.TileHeight}this.setTilePositions(this.rowscols,this.tiles,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),d=1e3}setTimeout(function(){for(var b=0;b<a.tiles.length;b++){var c=a.tiles[b];if(c._locations[0].startx=c._locations[0].x,c._locations[0].starty=c._locations[0].y,c.startwidth=c.width,c.startheight=c.height,!c.filtered||!Settings.showMissing&&c.missing){c.start=PivotViewer.Utils.now(),c.end=c.start+1e3;var d=Math.atan2(c._locations[0].y-a.currentHeight/2,c._locations[0].x-a.currentWidth/2);c._locations[0].destinationx=a.currentWidth*Math.cos(d)+a.currentWidth/2,c._locations[0].destinationy=a.currentHeight*Math.sin(d)+a.currentHeight/2,c.destinationwidth=1,c.destinationheight=1}}a.maxRatio=TileController._imageController.getRatio(a.tiles[0].item.img);for(var b=0;b<a.filterList.length;b++){var e=TileController._imageController.getRatio(a.filterList[b].item.img);e<a.maxRatio&&(a.maxRatio=e)}var f=a.filterList.length==a.tiles.length?0:500;setTimeout(function(){if(a.numMissing=0,!Settings.showMissing)for(var b=0;b<a.filterList.length;b++)a.filterList[b].missing&&a.numMissing++;a.resetUISettings();for(var b=0;b<a.tiles.length;b++){var c=a.tiles[b];c.origwidth=a.rowscols.TileHeight/TileController._imageController.getRatio(c.item.img),c.origheight=a.rowscols.TileHeight}a.setTilePositions(a.rowscols,a.filterList,a.offsetX,a.offsetY,!1,!1,1e3)},f)},d)}},getButtonImage:function(){return"images/GridView.png"},getButtonImageSelected:function(){return"images/GridViewSelected.png"},getViewName:function(){return"Grid View"},setTilePositions:function(a,b,c,d,e,f,g){var h=f&&this.rowscols?this.rowscols.Columns:a.Columns;f||(this.rowscols=a);for(var i=0,j=0,k=0;k<b.length;k++){var l=b[k];!Settings.showMissing&&l.missing||(e&&(l._locations[0].startx=l._locations[0].x,l._locations[0].starty=l._locations[0].y,l.startwidth=l.width,l.startheight=l.height),l.destinationwidth=a.TileMaxWidth,l.destinationheight=a.TileHeight,l._locations[0].destinationx=i*a.TileMaxWidth+c,l._locations[0].destinationy=j*a.TileHeight+d,l.start=PivotViewer.Utils.now(),l.end=l.start+g,i==h-1?(i=0,j++):i++)}},centerOnTile:function(a){var b=Math.round((a._locations[0].x-this.currentOffsetX)/a.width),c=Math.round((a._locations[0].y-this.currentOffsetY)/a.height),d=a.context.canvas.height,e=a.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());a.height/d>a.height/TileController._imageController.getRatio(a.item.img)/e?origProportion=a.origheight/d:origProportion=a.origwidth/e,null==this.selected&&PV.zoom(Math.round(.75/origProportion*2)),this.currentOffsetX=this.rowscols.TileMaxWidth*-b+this.width/2-this.rowscols.TileMaxWidth/2,this.currentOffsetY=this.rowscols.TileHeight*-c+this.height/2-this.rowscols.TileHeight/2,this.setTilePositions(this.rowscols,this.filterList,this.currentOffsetX,this.currentOffsetY,!0,!0,1e3)},handleClick:function(a){var b=this._super(a);null!=b&&b.setSelected(!0),"init"==a.type&&this.resetUISettings(),null!=b&&this.selected!=b?this.centerOnTile(b):(this.selected=b=null,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,PV.zoom(0)),$.publish("/PivotViewer/Views/Item/Selected",[{item:b}])}});
