PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a;var b=this;this._tiles.push=function(a){this.__proto__.push.apply(b._tiles,[a]),b._tilesById[a.item.id]=a}},getTileById:function(a){var b=this._tilesById[a];return void 0==b?null:b},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.item=a[d],this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},animateTiles:function(){var a=this;this._started=!0;var b=null,c=this._tiles;if(c.length>0&&null!=c[0].context){b=c[0].context,b.canvas.width=$(".pv-canvas").width(),b.canvas.height=$(".pv-canvas").height();for(var d=!1,e=0;e<c.length;e++){var f=c[e],g=f._locations;for(k=0;k<g.length;k++){var h=g[k],i=PivotViewer.Utils.now()-f.start,j=f.end-f.start;i<=j?(h.x==h.destinationx&&h.y==h.destinationy||(d=!0),h.x=this._easing.ease(i,h.startx,h.destinationx-h.startx,j),h.y=this._easing.ease(i,h.starty,h.destinationy-h.starty,j),f.width==f.destinationWidth&&f.height==f.destinationHeight||(d=!0),f.width=this._easing.ease(i,f.startwidth,f.destinationwidth-f.startwidth,j),f.height=this._easing.ease(i,f.startheight,f.destinationheight-f.startheight,j)):(h.x=h.destinationx,h.y=h.destinationy,f.width=f.destinationwidth,f.height=f.destinationheight),f.destinationVisible=!(h.destinationx+f.destinationwidth<0||h.destinationx>b.canvas.width||h.destinationy+f.destinationheight<0||h.destinationy>b.canvas.height)}}}this._isZooming!=d&&(this._isZooming=d,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);for(var e=0;e<c.length;e++)for(var f=c[e],g=f._locations,k=0;k<g.length;k++){var h=g[k];h.x+f.width>0&&h.x<b.canvas.width&&h.y+f.height>0&&h.y<b.canvas.height&&f.draw(k)}this._breaks?this._started=!1:requestAnimFrame(function(){a.animateTiles()})},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){return this instanceof PivotViewer.Views.Tile?(this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],void(this._visible=!0)):new PivotViewer.Views.Tile(a)},draw:function(a){var b=this._locations[a],c=TileController._imageController,d=this.context;if(this.destinationVisible&&(this._images=c.getImages(this.item.img,this.width,this.height)),null!=this._images){if("function"==typeof this._images)this._images(this.item,d,b.x+4,b.y+4,this.width-8,this.height-8);else if(this._images.length>0&&this._images[0]instanceof Image){var e=c.getHeight(this.item.img),f=c.getWidth(this.item.img),g=this.height-Math.ceil(this.height<128?this.height/16:8),h=this.width-Math.ceil(this.width<128?this.width/16:8),i=this.width-8-h,k=(this.height-8-g,0),l=0,m=h,n=g;if(c instanceof PivotViewer.Views.DeepZoomImageController){var o=c._tileSize;lvl=this._images[0].src.match(/_files\/[0-9]+\//g)[0];var p=parseInt(lvl.substring(7,lvl.length-1)),q=1<<c.getMaxLevel(this.item.img)-p,r=Math.ceil(e/q),s=Math.ceil(f/q),t=g/r,u=h/s,v=t<u?t:u;m=s*v,n=r*v,k=Math.floor((h-m)/2),l=Math.floor((g-n)/2),overlap=c.getOverlap(this.item.img);for(var w=0;w<this._images.length;w++){var x=this._images[w].src,y=x.match(/[0-9]+_[0-9]+/g),z=y[y.length-1],A=parseInt(z.substring(0,z.indexOf("_"))),B=parseInt(z.substring(z.indexOf("_")+1)),C=Math.ceil(this._images[w].height*v),D=Math.ceil(this._images[w].width*v),E=Math.floor((o-overlap)*v),F=k+4+A*E,G=l+4+B*E;d.drawImage(this._images[w],F+b.x,G+b.y,D,C)}}else{var F=Math.floor(i/2)+4,G=4;d.drawImage(this._images[0],F+this._locations[a].x,G+this._locations[a].y,h,g)}if(this._selected){d.beginPath();var F=k+4,G=l+4;d.rect(F+this._locations[this.selectedLoc].x,G+this._locations[this.selectedLoc].y,m,n),d.lineWidth=4,d.strokeStyle="#92C4E1",d.stroke()}}}else this.drawEmpty(a)},contains:function(a,b){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=a&&this._locations[i].x+this.width>=a&&this._locations[i].y<=b&&this._locations[i].y+this.height>=b)return i;return-1},drawEmpty:function(a){var b=TileController._imageController,c=this.context;void 0==b.DrawLevel?(c.beginPath(),c.fillStyle="#D7DDDD",c.fillRect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),c.rect(this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8),c.lineWidth=1,c.strokeStyle="white",c.stroke()):b.DrawLevel(this.item,c,this._locations[a].x+4,this._locations[a].y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(a,b,c){this._selected=a,null!=b&&(this.selectedLoc=b),null!=c&&(this.cellLoc=c)}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});
