PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a;var b=this;this._tiles.push=function(a){this.__proto__.push.apply(b._tiles,[a]),b._tilesById[a.item.id]=a},this.isZooming=!1,this._started=!1},getTileById:function(a){var b=this._tilesById[a];return void 0==b?null:b},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.item=a[d],this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},animateTiles:function(){var a=this;this._started=!0;var b=null,c=this._tiles;if(this._breaks=!1,c.length>0&&null!=c[0].context){b=c[0].context;for(var d=b.canvas.width=$(".pv-canvas").width(),e=b.canvas.height=$(".pv-canvas").height(),f=!1,g=0;g<c.length;g++){var h=c[g],i=h._locations;for(t=0;t<i.length;t++){var j=i[t],k=PivotViewer.Utils.now()-h.start,l=h.end-h.start;k<=l?(j.x==j.destinationx&&j.y==j.destinationy||(f=!0),j.x=this._easing.ease(k,j.startx,j.destinationx-j.startx,l),j.y=this._easing.ease(k,j.starty,j.destinationy-j.starty,l),h.width==h.destinationWidth&&h.height==h.destinationHeight||(f=!0),h.width=this._easing.ease(k,h.startwidth,h.destinationwidth-h.startwidth,l),h.height=this._easing.ease(k,h.startheight,h.destinationheight-h.startheight,l)):(j.x=j.destinationx,j.y=j.destinationy,h.width=h.destinationwidth,h.height=h.destinationheight),j.destinationx+h.destinationwidth<0||j.destinationx>d||j.destinationy+h.destinationheight<0||j.destinationy>e?h.destinationVisible=!1:h.destinationVisible=!0}}}this._isZooming!=f&&(this._isZooming=f,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);var m=12,n=new Array(c.length),b=c[0].context;b.font=m+"px Roboto,Helvetica,Arial,sans-serif";for(var o=0,p=0,q=0,r=0,s=0,g=0;g<c.length;g++){var h=c[g],i=h._locations;n[g]=new Array(i.length);for(var t=0;t<i.length;t++){var j=i[t],u=j.x+h.width,v=j.y+h.height,w=0<=j.x&&j.x<b.canvas.width&&0<=j.y&&j.y<b.canvas.height||0<=j.x&&j.x<b.canvas.width&&0<=v&&v<b.canvas.height||0<=u&&u<b.canvas.width&&0<=j.y&&j.y<b.canvas.height||0<=u&&u<b.canvas.width&&0<=v&&v<b.canvas.height||0<=j.x&&j.x<b.canvas.width&&j.y<b.canvas.height||0<=j.y&&j.y<b.canvas.height&&j.x<b.canvas.width||j.x<=0&&0<=u&&j.y<=0&&0<=v;if(w){var x=b.measureText(h.item.name);o+=x.width,x.width>q&&(q=x.width),p+=h.item.name.length,h.item.name.length>r&&(r=h.item.name.length),n[g][t]=h.draw(t),s<h.width&&(s=h.width)}}}var y=s-24,z=Math.floor(y/q*m);z>30&&(z=30);var A=z>=m;if(!A){var B=o/p,C=y+3*B;for(r-=3;r>=20&&!A;r--)z=Math.floor(C/(r*B)*m),A=z>=m}if(A){$.publish("/PivotViewer/ImageController/TooltipEnable",[!1]),b.font=z+"px Roboto,Helvetica,Arial,sans-serif";for(var g=0;g<c.length;g++)for(var h=c[g],i=h._locations,t=0;t<i.length;t++){var D=n[g][t];if(void 0!=D&&0!=D[0]){j=i[t];var E=D[0],F=D[1],G=h.item.name;G.length>r&&(G=G.substr(0,r)+"...");var x=b.measureText(G),j=i[t],H=(h.width-E)/2,I=(h.height-F)/2,u=j.x+H+(E-8-x.width)/2,v=j.y+I+F-(4+z);b.save(),b.strokeStyle="rgb( 0, 0, 0 )",b.fillStyle="rgba( 64, 64, 64, .5)",this.roundRect(b,u-2,v-z,x.width+4,z+4,5,!0,!1),b.restore(),b.save(),b.fillStyle="rgba( 255, 255, 255 ,1 )",b.fillText(G,u,v),b.restore()}}}else $.publish("/PivotViewer/ImageController/TooltipEnable",[!0]);this._breaks?(window.setTimeout(function(){a.animateTiles()},250),this._started=!1):requestAnimFrame(function(){a.animateTiles()})},roundRect:function(a,b,c,d,e,f,g,h){if("undefined"==typeof h&&(h=!0),"undefined"==typeof f&&(f=5),"number"==typeof f)f={tl:f,tr:f,br:f,bl:f};else{var i={tl:0,tr:0,br:0,bl:0};for(var j in i)f[j]=f[j]||i[j]}a.beginPath(),a.moveTo(b+f.tl,c),a.lineTo(b+d-f.tr,c),a.quadraticCurveTo(b+d,c,b+d,c+f.tr),a.lineTo(b+d,c+e-f.br),a.quadraticCurveTo(b+d,c+e,b+d-f.br,c+e),a.lineTo(b+f.bl,c+e),a.quadraticCurveTo(b,c+e,b,c+e-f.bl),a.lineTo(b,c+f.tl),a.quadraticCurveTo(b,c,b+f.tl,c),a.closePath(),g&&a.fill(),h&&a.stroke()},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){return this instanceof PivotViewer.Views.Tile?(this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],void(this._visible=!0)):new PivotViewer.Views.Tile(a)},draw:function(a){if(0!=this.width&&0!=this.height){var b=this._locations[a],c=TileController._imageController,d=this.context,e=0,f=0;if(this.destinationVisible&&(this._images=c.getImages(this.item.img,this.width,this.height)),null!=this._images)try{var g=c.getHeight(this.item.img),h=c.getWidth(this.item.img),i=this.height-Math.ceil(this.height<128?this.height/16:8),j=this.width-Math.ceil(this.width<128?this.width/16:8),k=this.width-8-j,m=(this.height-8-i,0),n=0;e=j,f=i;var o=c._tileSize,p=Math.ceil(Math.log(this.width>this.height?this.width:this.height)/Math.log(2));p!=1/0&&p!=-(1/0)||(p=0);var q=c.getMaxLevel(this.item.img);p>q&&(p=q);var r=1<<q-p,s=Math.ceil(g/r),t=Math.ceil(h/r),u=i/s,v=j/t,w=u<v?u:v;if(e=Math.ceil(t*w),f=Math.ceil(s*w),m=Math.floor((j-e)/2),n=Math.floor((i-f)/2),"function"==typeof this._images)this._images(d,b.x+m,b.y+n,e,f);else if(this._images.length>0&&this._images[0]instanceof Image){if(c instanceof PivotViewer.Views.DeepZoomImageController){var o=c._tileSize;lvl=this._images[0].src.match(/_files\/[0-9]+\//g)[0];var x=parseInt(lvl.substring(7,lvl.length-1)),r=1<<c.getMaxLevel(this.item.img)-x,s=Math.ceil(g/r),t=Math.ceil(h/r),u=i/s,v=j/t,w=u<v?u:v;e=t*w,f=s*w,m=Math.floor((j-e)/2),n=Math.floor((i-f)/2),overlap=c.getOverlap(this.item.img);for(var y=0,z=0,A=0;A<this._images.length;A++){var B=this._images[A].src,C=B.match(/[0-9]+_[0-9]+/g),D=C[C.length-1],E=parseInt(D.substring(0,D.indexOf("_"))),F=parseInt(D.substring(D.indexOf("_")+1)),G=Math.floor(this._images[A].height*w),H=Math.floor(this._images[A].width*w),I=(o-overlap)*w,J=m+E*I,K=n+F*I;d.drawImage(this._images[A],J+b.x,K+b.y,H,G);var L=parseInt(J+b.x+H),M=parseInt(K+b.y+G);y<L&&(y=L),z<M&&(z=M)}e=parseInt(y-(b.x+m)),f=parseInt(z-(b.y+n))}else{var J=Math.floor(k/2)+4,K=4;d.drawImage(this._images[0],J+b.x,K+b.y,j,i)}if(this._selected){d.beginPath();var J=m,K=n;d.rect(J+this._locations[this.selectedLoc].x,K+this._locations[this.selectedLoc].y,e+2,f+2),d.lineWidth=4,d.strokeStyle="#92C4E1",d.stroke()}}}catch(b){this.drawEmpty(a)}else this.drawEmpty(a);return[e,f]}},contains:function(a,b){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=a&&this._locations[i].x+this.width>=a&&this._locations[i].y<=b&&this._locations[i].y+this.height>=b)return i;return-1},drawEmpty:function(a){var b=TileController._imageController,c=this.context,d=this._locations[a];void 0==b.DrawLevel?(c.beginPath(),c.fillStyle="#D7DDDD",c.fillRect(d.x+4,d.y+4,this.width-8,this.height-8),c.rect(d.x+4,d.y+4,this.width-8,this.height-8),c.lineWidth=1,c.strokeStyle="white",c.stroke()):b.DrawLevel(this.item,c,d.x+4,d.y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(a,b,c){a&&$.publish("/PivotViewer/ImageController/Selected",[this]),this._selected=a,null!=b&&(this.selectedLoc=b),null!=c&&(this.cellLoc=c)},isSelected:function(){return this._selected}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});
