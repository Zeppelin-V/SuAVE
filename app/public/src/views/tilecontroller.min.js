PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._tilesById=[],this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a;var b=this;this._tiles.push=function(a){this.__proto__.push.apply(b._tiles,[a]),b._tilesById[a.item.id]=a},this.isZooming=!1,this._started=!1},getTileById:function(a){var b=this._tilesById[a];return void 0==b?null:b},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.item=a[d],this._canvasContext=c,e.context=this._canvasContext,tileLocation=new PivotViewer.Views.TileLocation,e._locations.push(tileLocation),this._tiles.push(e)}return this._tiles},animateTiles:function(){var a=this;this._started=!0;var b=null,c=this._tiles;if(this._breaks=!1,c.length>0&&null!=c[0].context){b=c[0].context;for(var d=b.canvas.width=$(".pv-canvas").width(),e=b.canvas.height=$(".pv-canvas").height(),f=!1,g=0;g<c.length;g++){var h=c[g],i=h._locations;for(m=0;m<i.length;m++){var j=i[m],k=PivotViewer.Utils.now()-h.start,l=h.end-h.start;k<=l?(j.x==j.destinationx&&j.y==j.destinationy||(f=!0),j.x=this._easing.ease(k,j.startx,j.destinationx-j.startx,l),j.y=this._easing.ease(k,j.starty,j.destinationy-j.starty,l),h.width==h.destinationWidth&&h.height==h.destinationHeight||(f=!0),h.width=this._easing.ease(k,h.startwidth,h.destinationwidth-h.startwidth,l),h.height=this._easing.ease(k,h.startheight,h.destinationheight-h.startheight,l)):(j.x=j.destinationx,j.y=j.destinationy,h.width=h.destinationwidth,h.height=h.destinationheight,this._breaks=!0),j.destinationx+h.destinationwidth<0||j.destinationx>d||j.destinationy+h.destinationheight<0||j.destinationy>e?h.destinationVisible=!1:h.destinationVisible=!0}}}this._isZooming!=f&&(this._isZooming=f,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);for(var g=0;g<c.length;g++)for(var h=c[g],i=h._locations,m=0;m<i.length;m++){var j=i[m],n=j.x+h.width,o=j.y+h.height,p=0<=j.x&&j.x<b.canvas.width&&0<=j.y&&j.y<b.canvas.height||0<=j.x&&j.x<b.canvas.width&&0<=o&&o<b.canvas.height||0<=n&&n<b.canvas.width&&0<=j.y&&j.y<b.canvas.height||0<=n&&n<b.canvas.width&&0<=o&&o<b.canvas.height||0<=j.x&&j.x<b.canvas.width&&j.y<b.canvas.height||0<=j.y&&j.y<b.canvas.height&&j.x<b.canvas.width||j.x<=0&&0<=n&&j.y<=0&&0<=o;p&&h.draw(m)}this._breaks?(window.setTimeout(function(){a.animateTiles()},250),this._started=!1):requestAnimFrame(function(){a.animateTiles()})},beginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.animateTiles())},stopAnimation:function(){this._breaks=!0},setLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},setCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},setQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},getMaxTileRatio:function(){return this._imageController.MaxRatio}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){return this instanceof PivotViewer.Views.Tile?(this._imageLoaded=!1,this._selected=!1,this._images=null,this._locations=[],void(this._visible=!0)):new PivotViewer.Views.Tile(a)},draw:function(a){if(0!=this.width&&0!=this.height){var b=this._locations[a],c=TileController._imageController,d=this.context;if(this.destinationVisible&&(this._images=c.getImages(this.item.img,this.width,this.height)),null!=this._images)try{var e=c.getHeight(this.item.img),f=c.getWidth(this.item.img),g=this.height-Math.ceil(this.height<128?this.height/16:8),h=this.width-Math.ceil(this.width<128?this.width/16:8),i=this.width-8-h,k=(this.height-8-g,0),l=0,m=h,n=g,o=c._tileSize,p=Math.ceil(Math.log(this.width>this.height?this.width:this.height)/Math.log(2));p!=1/0&&p!=-(1/0)||(p=0);var q=c.getMaxLevel(this.item.img);p>q&&(p=q);var r=1<<q-p,s=Math.ceil(e/r),t=Math.ceil(f/r),u=g/s,v=h/t,w=u<v?u:v;if(m=Math.ceil(t*w),n=Math.ceil(s*w),k=Math.floor((h-m)/2),l=Math.floor((g-n)/2),"function"==typeof this._images)this._images(d,b.x+k,b.y+l,m,n);else if(this._images.length>0&&this._images[0]instanceof Image){if(c instanceof PivotViewer.Views.DeepZoomImageController){var o=c._tileSize;lvl=this._images[0].src.match(/_files\/[0-9]+\//g)[0];var x=parseInt(lvl.substring(7,lvl.length-1)),r=1<<c.getMaxLevel(this.item.img)-x,s=Math.ceil(e/r),t=Math.ceil(f/r),u=g/s,v=h/t,w=u<v?u:v;m=t*w,n=s*w,k=Math.floor((h-m)/2),l=Math.floor((g-n)/2),overlap=c.getOverlap(this.item.img);for(var y=0,z=0,A=0;A<this._images.length;A++){var B=this._images[A].src,C=B.match(/[0-9]+_[0-9]+/g),D=C[C.length-1],E=parseInt(D.substring(0,D.indexOf("_"))),F=parseInt(D.substring(D.indexOf("_")+1)),G=Math.floor(this._images[A].height*w),H=Math.floor(this._images[A].width*w),I=(o-overlap)*w,J=k+E*I,K=l+F*I;d.drawImage(this._images[A],J+b.x,K+b.y,H,G);var L=parseInt(J+b.x+H),M=parseInt(K+b.y+G);y<L&&(y=L),z<M&&(z=M)}m=parseInt(y-(b.x+k)),n=parseInt(z-(b.y+l))}else{var J=Math.floor(i/2)+4,K=4;d.drawImage(this._images[0],J+b.x,K+b.y,h,g)}if(this._selected){d.beginPath();var J=k,K=l;d.rect(J+this._locations[this.selectedLoc].x,K+this._locations[this.selectedLoc].y,m+2,n+2),d.lineWidth=4,d.strokeStyle="#92C4E1",d.stroke()}}}catch(b){this.drawEmpty(a)}else this.drawEmpty(a)}},contains:function(a,b){for(i=0;i<this._locations.length;i++)if(this._locations[i].x<=a&&this._locations[i].x+this.width>=a&&this._locations[i].y<=b&&this._locations[i].y+this.height>=b)return i;return-1},drawEmpty:function(a){var b=TileController._imageController,c=this.context,d=this._locations[a];void 0==b.DrawLevel?(c.beginPath(),c.fillStyle="#D7DDDD",c.fillRect(d.x+4,d.y+4,this.width-8,this.height-8),c.rect(d.x+4,d.y+4,this.width-8,this.height-8),c.lineWidth=1,c.strokeStyle="white",c.stroke()):b.DrawLevel(this.item,c,d.x+4,d.y+4,this.width-8,this.height-8)},now:null,end:null,width:0,height:0,origwidth:0,origheight:0,ratio:1,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,item:null,firstFilterItemDone:!1,selectedLoc:0,setSelected:function(a,b,c){this._selected=a,null!=b&&(this.selectedLoc=b),null!=c&&(this.cellLoc=c)}}),PivotViewer.Views.TileLocation=Object.subClass({init:function(){},x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0});
