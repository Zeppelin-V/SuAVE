PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._itemsById=[],this._collageItems=[],this.baseUrl="",this._collageMaxLevel=0,this._collageItemOverlap=1,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=0,this._dziQueue=[],this._zooming=!1;var a=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(b){a._zooming=b})},setup:function(a){this.baseUrl=a.substring(0,a.lastIndexOf("/")),this._collageUrl=a.substring(a.lastIndexOf("/")+1).replace(".xml","_files");var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){var c=$(a).find("Collection");b._tileSize=$(c).attr("TileSize"),b._format=$(c).attr("Format"),b._collageMaxLevel=$(c).attr("MaxLevel");var d=$(c).attr("ItemOverlap");b._collageItemOverlap=void 0!=d&&null!=d?d:1;var e=$(c).attr("ImageSrc");void 0!=e&&null!=e&&(b.baseUrl=e);var f=$(a).find("I");if(0==f.length){$(".pv-loading").remove();var g="No items in the DeepZoom Collection<br><br>";return g+="URL        : "+this.url+"<br>",g+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+g+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}var h=$(f[0]).find("Size");if(h.length>0)for(b.MaxWidth=parseInt(h.attr("Width")),b.Height=parseInt(h.attr("Height")),b.MaxRatio=0,i=0;i<f.length;i++){itemSize=$(f[i]).find("Size");var j=parseInt(itemSize.attr("Width")),k=parseInt(itemSize.attr("Height")),l=j>k?j:k,m=Math.ceil(Math.log(l)/Math.log(2));b._ratio=k/j;var n=$(f[i]).attr("Source"),o=$(f[i]).attr("Id"),p=$(f[i]).attr("N"),q=n.substring(n.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),r=n.substring(0,n.lastIndexOf("/"));r.length>0&&(r+="/"),j>b.MaxWidth&&(b.MaxWidth=j),b.MaxRatio+=b._ratio;var s=new PivotViewer.Views.DeepZoomItem(o,q,p,r,b._ratio,j,k,m,b.baseUrl,n);b._items.push(s),b._itemsById[o]=s}b.MaxRatio/=f.length,$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="Error loading from DeepZoom Cache<br><br>";d+="URL        : "+this.url+"<br>",d+="Status : "+a.status+" "+c+"<br>",d+="Details    : "+a.responseText+"<br>",d+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+d+"</p></div></div>"),setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},getImages:function(a,b,c){var d=Math.ceil(Math.log(b>c?b:c)/Math.log(2));return d!=1/0&&d!=-(1/0)||(d=0),this.getImagesAtLevel(a,d)},getImagesAtLevel:function(a,b){b=b<=0?6:b;var c=this._itemsById[a];b=b>c.MaxLevel?c.MaxLevel:b;for(var d=c.DZN.toString(2),e="",f="",g=0;g<d.length;g++)g%2==0?e+=d[g]:f+=d[g];if(dzCol=parseInt(e,2),dzRow=parseInt(f,2),!(void 0!=c.Levels&&0!=c.Levels.length||this._zooming)){var h=this.getImageList(a,this.baseUrl+"/"+c.BasePath+c.DZId+"_files/6/",6);return c.Levels.push(new PivotViewer.Views.ImageLevel(h)),null}if(c.Levels.length<b&&!this._zooming){var h=this.getImageList(a,this.baseUrl+"/"+c.BasePath+c.DZId+"_files/"+b+"/",b);c.Levels.splice(b,0,new PivotViewer.Views.ImageLevel(h))}for(var i=b;i>-1;i--){if(void 0!=c.Levels[i]&&c.Levels[i].IsLoaded())return c.Levels[i].getImages();if(i==b&&void 0==c.Levels[i]&&!this._zooming){var h=this.getImageList(a,this.baseUrl+"/"+c.BasePath+c.DZId+"_files/"+i+"/",i);c.Levels[i]=new PivotViewer.Views.ImageLevel(h);break}}return null},getImageList:function(a,b,c){for(var d=[],e=this._tileSize,f=this._itemsById[a],g=f.Height,h=f.MaxLevel,i=Math.ceil(g/f.Ratio/Math.pow(2,h-c)),j=Math.ceil(g/Math.pow(2,h-c)),k=Math.ceil(i/e),l=Math.ceil(j/e),m=0;m<k;m++)for(var n=0;n<l;n++)d.push(b+m+"_"+n+"."+this._format);return d},getWidthForImage:function(a,b){return Math.floor(b/this._itemsById[a].Ratio)},getMaxLevel:function(a){return this._itemsById[a].MaxLevel},getHeight:function(a){return this._itemsById[a].Height},getWidth:function(a){return this._itemsById[a].Width},getOverlap:function(a){return this._collageItemOverlap},getRatio:function(a){return this._itemsById[a].Ratio}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(a,b,c,d,e,f,g,h,i,j){this.ItemId=a,this.DZId=b,this.DZN=parseInt(c),this.BasePath=d,this.Levels=[],this.Ratio=e,this.Width=f,this.Height=g,this.MaxLevel=h;var l=TileController._imageController._dziQueue[b];void 0==l?(l=TileController._imageController._dziQueue[b]=[],l.push(this)):l.push(this)}}),PivotViewer.Views.ImageLevel=Object.subClass({init:function(a){this._images=[],this._loaded=!1;for(var b=this,c=0;c<a.length;c++){var d=new Image;d.src=a[c],d.onload=function(){b._loaded=!0},this._images.push(d)}},getImages:function(){return this._images},IsLoaded:function(){return this._loaded}});
