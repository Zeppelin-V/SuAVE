PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._itemsById=[],this._collageItems=[],this.baseUrl="",this._collageMaxLevel=0,this._collageItemOverlap=1,this._tileSize=256,this._format="",this._ratio=1,this.MaxRatio=0,this._dziQueue=[],this._zooming=!1,this._max_sprite_level=-1,this._sprite_index=[],this._sprite_sheet_url=[],this._sprite_sheet_loaded=[],this._sprite_sheet=[];var a=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(b){a._zooming=b})},setup:function(a){this.baseUrl=a.substring(0,a.lastIndexOf("/")),this._collageUrl=a.substring(a.lastIndexOf("/")+1).replace(".xml","_files"),this.getSpriteIndex(a,this.getDeepzoom)},getSpriteIndex:function(a,b){this._dzc=a,this._cb=b,this._the_other=c;var c=this;$.ajax({type:"GET",url:this.baseUrl+"/sprite.idx",dataType:"xml",success:function(a){var b=$(a).find("SpriteIndex");c._max_sprite_level=$(b).attr("maxdepth");for(var d=$(b).find("Tile"),e=0;e<d.length;e++){for(var f=d[e],g=[],h=$(f).find("TileParams"),i=0;i<h.length;i++){var j=h[i];g[$(j).attr("level")]={width:$(j).attr("width"),height:$(j).attr("height")}}c._sprite_index[$(f).attr("object")]={x:$(f).attr("x"),y:$(f).attr("y"),params:g}}for(var k=$(a).find("SpriteSheet"),l=0;l<k.length;l++){var m=k[l],n=$(m).attr("index");c._sprite_sheet_url[n]=c.baseUrl+"/"+$(m).attr("sprite");var o=new Image;o.src=c._sprite_sheet_url[n]}c._cb(c._dzc)},error:function(a,b,d){c._cb(c._dzc)}})},getDeepzoom:function(a){var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){var c=$(a).find("Collection");b._tileSize=$(c).attr("TileSize"),b._format=$(c).attr("Format"),b._collageMaxLevel=$(c).attr("MaxLevel");var d=$(c).attr("ItemOverlap");b._collageItemOverlap=void 0!=d&&null!=d?d:1,b._tileSize-=2*b._collageItemOverlap;var e=$(c).attr("ImageSrc");void 0!=e&&null!=e&&(b.baseUrl=e);var f=$(a).find("I");if(0==f.length){$(".pv-loading").remove();var g="No items in the DeepZoom Collection<br><br>";return g+="URL        : "+this.url+"<br>",g+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+g+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}var h=$(f[0]).find("Size");if(h.length>0)for(b.MaxWidth=parseInt(h.attr("Width")),b.Height=parseInt(h.attr("Height")),b.MaxRatio=0,i=0;i<f.length;i++){itemSize=$(f[i]).find("Size");var j=parseInt(itemSize.attr("Width")),k=parseInt(itemSize.attr("Height")),l=j>k?j:k,m=Math.ceil(Math.log(l)/Math.log(2));b._ratio=k/j;var n=$(f[i]).attr("Source"),o=$(f[i]).attr("Id"),p=$(f[i]).attr("N"),q=n.substring(n.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),r=n.substring(0,n.lastIndexOf("/"));r.length>0&&(r+="/"),j>b.MaxWidth&&(b.MaxWidth=j),b.MaxRatio+=b._ratio;var s=new PivotViewer.Views.DeepZoomItem(o,q,p,r,b._ratio,j,k,m,b.baseUrl,n);b._items.push(s),b._itemsById[o]=s}b.MaxRatio/=f.length,$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="Error loading from DeepZoom Cache<br><br>";d+="URL        : "+this.url+"<br>",d+="Status : "+a.status+" "+c+"<br>",d+="Details    : "+a.responseText+"<br>",d+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+d+"</p></div></div>"),setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}})},getImages:function(a,b,c){var d=Math.ceil(Math.log(b>c?b:c)/Math.log(2));return d!=1/0&&d!=-(1/0)||(d=0),this.getImagesAtLevel(a,d)},getImagesAtLevel:function(a,b){if(b<0&&(b=0),b<=this._max_sprite_level)return this.spriteLoad(a,b);var c=this._itemsById[a];if(b=b>c.MaxLevel?c.MaxLevel:b,void 0==c.Levels[b]&&!this._zooming){var d=this.getImageList(a,this.baseUrl+"/"+c.BasePath+c.DZId+"_files/"+b+"/",b);c.Levels[b]=new PivotViewer.Views.ImageLevel(d)}for(var e=b;e>this._max_sprite_level;e--)if(void 0!=c.Levels[e]&&c.Levels[e].IsLoaded())return c.Levels[e].getImages();if(void 0==c.Levels[b]&&!this._zooming){var d=this.getImageList(a,this.baseUrl+"/"+c.BasePath+c.DZId+"_files/"+b+"/",b);c.Levels[b]=new PivotViewer.Views.ImageLevel(d)}for(var f=null,g=this._max_sprite_level;g>=0&&(f=this.spriteLoad(a,g),null==f);g--);return f},spriteLoad:function(a,b){var c=null;if(void 0==this._sprite_sheet[b]){if(void 0!=this._sprite_sheet_url[b]&&void 0==this._sprite_sheet_loaded[b]){this._sprite_sheet_loaded[b]=!1,this._sprite_sheet[b]=new Image,this._sprite_sheet[b].src=this._sprite_sheet_url[b];var d=this,e=b;this._sprite_sheet[b].onload=function(){d._sprite_sheet_loaded[e]=!0}}}else if(this._sprite_sheet_loaded[b])try{var f=this._sprite_sheet[b],g=this._sprite_index[a],h=g.params[b],i=1<<b,j=i*g.x,k=i*g.y,l=h.width,m=h.height;c=function(a,b,c,d,e){var g=d/l,h=e/m,i=g<h?g:h,n=Math.floor(l*i),o=Math.floor(m*i),p=Math.floor((d-n)/2),q=Math.floor((e-o)/2);a.drawImage(f,j,k,l,m,b+p,c+q,n,o)}}catch(b){$(".pv-loading").remove();var n="Error in DeepZoom Collection<br><br>";return n+="Unable to find id '"+a+"'<br>",n+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+n+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}return c},getImageList:function(a,b,c){for(var d=[],e=this._tileSize,f=this._itemsById[a],g=f.Height,h=f.MaxLevel,i=Math.ceil(g/f.Ratio/Math.pow(2,h-c)),j=Math.ceil(g/Math.pow(2,h-c)),k=Math.ceil(i/e),l=Math.ceil(j/e),m=0;m<k;m++)for(var n=0;n<l;n++)d.push(b+m+"_"+n+"."+this._format);return d},getWidthForImage:function(a,b){return Math.floor(b/this._itemsById[a].Ratio)},getMaxLevel:function(a){return this._itemsById[a].MaxLevel},getHeight:function(a){return this._itemsById[a].Height},getWidth:function(a){return this._itemsById[a].Width},getOverlap:function(a){return this._collageItemOverlap},getRatio:function(a){try{return this._itemsById[a].Ratio}catch(c){$(".pv-loading").remove();var b="Missing image in DeepZoom Collection<br><br>";return b+="Can't find '"+a+"'</br>",b+="<br>Pivot Viewer cannot continue until this problem is resolved<br>",$(".pv-wrapper").append('<div id="pv-dzloading-error" class="pv-modal-dialog"><div><a href="#pv-modal-dialog-close" title="Close" class="pv-modal-dialog-close">X</a><h2>HTML5 PivotViewer</h2><p>'+b+"</p></div></div>"),void setTimeout(function(){window.open("#pv-dzloading-error","_self")},1e3)}}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(a,b,c,d,e,f,g,h,i,j){this.ItemId=a,this.DZId=b,this.DZN=parseInt(c),this.BasePath=d,this.Levels=[],this.Ratio=e,this.Width=f,this.Height=g,this.MaxLevel=h;var l=TileController._imageController._dziQueue[b];void 0==l?(l=TileController._imageController._dziQueue[b]=[],l.push(this)):l.push(this)}}),PivotViewer.Views.ImageLevel=Object.subClass({init:function(a){this._images=[],this._loaded=!1;for(var b=this,c=0;c<a.length;c++){var d=new Image;d.src=a[c],console.debug("load image "+d.src),d.onload=function(){b._loaded=!0},this._images.push(d)}},getImages:function(){return this._images},IsLoaded:function(){return this._loaded}});
