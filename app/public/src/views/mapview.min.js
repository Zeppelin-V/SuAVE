PivotViewer.Utils.loadScript("lib/wicket/wicket.min.js"),PivotViewer.Utils.loadCSS("lib/leaflet/leaflet.css"),PivotViewer.Utils.loadScript("lib/leaflet/leaflet.js"),PivotViewer.Views.MapView=PivotViewer.Views.IPivotViewerView.subClass({init:function(){this._super(),this.locCache=[],this.map=null,this.markers=[],this.overlay,this.overlayBaseImageUrl=null,this.itemsToGeocode=[],this.startGeocode,this.geocodeZero,this.applyBookmark=!1,this.mapService=null,this.APIKey=null,this.geocodeService=null,this.geometryValue=null,this.areaValues=[],this.areaObj,this.buckets=[],this.icons=[],this.iconsSelected=[],this.selectedMarker=null,this.selectedBucket=-1;var a=this;$.subscribe("/PivotViewer/Views/Item/Selected",function(b){a.isActive&&a.selectMarker(b.item)})},setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,Modernizr.localstorage?this.localStorage=!0:this.localStorage=!1,window.mapView=this},apiLoaded:function(){var a=this;this.map=new google.maps.Map(document.getElementById("pv-map-canvas")),google.maps.event.addListener(this.map,"zoom_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),a.getOverlay()}),google.maps.event.addListener(this.map,"center_changed",function(){$.publish("/PivotViewer/Views/Item/Updated",null),a.getOverlay()}),this.icons=["lib/leaflet/images/Red.png","lib/leaflet/images/Yellow.png","lib/leaflet/images/DarkGreen.png","lib/leaflet/images/Blue.png","lib/leaflet/images/Purple.png","lib/leaflet/images/Orange.png","lib/leaflet/images/Pink.png","lib/leaflet/images/Sky.png","lib/leaflet/images/Lime.png","lib/leaflet/images/Gold.png","lib/leaflet/images/Green.png"],this.iconsSelected=["lib/leaflet/images/RedDot.png","lib/leaflet/images/YellowDot.png","lib/leaflet/images/DarkGreenDot.png","lib/leaflet/images/BlueDot.png","lib/leaflet/images/PurpleDot.png","lib/leaflet/images/OrangeDot.png","lib/leaflet/images/PinkDot.png","lib/leaflet/images/SkyDot.png","lib/leaflet/images/LimeDot.png","lib/leaflet/images/GoldDot.png","lib/leaflet/images/GreenDot.png"],this.clearMarkers=function(){for(var a=0;a<this.tiles.length;a++){var b=this.tiles[a].marker;void 0!=b&&b.setMap(null)}},this.selectMarker=function(b){var c=a.getBucketNumber(b);if(b.marker==a.selectedMarker)b.marker.setIcon(a.icons[c]),a.selected=null,a.selectedMarker.setZIndex(0),a.selectedMarker=null,a.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{c instanceof Array&&(c=c[0]),b.marker.setIcon(a.iconsSelected[c]),b.marker.setZIndex(1e9),a.selected=b,null!=a.selectedMarker&&(a.selectedMarker.setZIndex(0),a.selectedMarker.setIcon(a.icons[a.selectedBucket])),a.selectedMarker=b.marker,a.selectedBucket=c,a.map.panTo(b.loc),$(".pv-toolbarpanel-info").empty();var d="<img style='height:15px;width:auto' src='"+a.icons[c]+"'></img>";d+=a.buckets[c].startRange==a.buckets[c].endRange?a.buckets[c].startRange:a.buckets[c].startRange+" to "+a.buckets[c].endRange,$(".pv-toolbarpanel-info").append(d),$(".pv-altinfopanel").hide()}},this.newMarker=function(a){a.marker=new google.maps.Marker({position:a.loc,map:this.map,title:a.item.name}),a.marker.setIcon(this.icons[this.buckets.ids[a.item.id]]),google.maps.event.addListener(a.marker,"click",function(a){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:a}])}}(a))},this.refitBounds=function(){var a=new google.maps.LatLngBounds;for(i=0;i<this.filterList.length;i++){var b=this.filterList[i];void 0==b.loc||!Settings.showMissing&&b.missing||a.extend(b.marker.position)}this.map.fitBounds(a)},this.getOverlay=function(){var a=this.map.getBounds();if(a){var b=a.getSouthWest(),c=a.getNorthEast(),d=$("#pv-map-canvas").width(),e=$("#pv-map-canvas").height();if(null!=this.overlayBaseImageUrl){this.overlay&&this.overlay.setMap(null);var f=this.overlayBaseImageUrl+"&bbox="+b.lng()+","+b.lat()+","+c.lng()+","+c.lat()+"&width="+d+"&height="+e;this.overlay=new google.maps.GroundOverlay(f,a,{opacity:.4}),this.overlay.setMap(this.map)}}},$(".pv-mainpanel").append("<div class='pv-altinfopanel' id='pv-altinfopanel'></div>"),$(".pv-altinfopanel").css("left",$(".pv-mainpanel").offset().left+$(".pv-mainpanel").width()-205+"px").css("height",$(window).height()-$(".pv-toolbarpanel").height()-58+"px"),this.activate()},setOptions:function(a){if($(".pv-viewpanel").append("<div class='pv-mapview-canvas' id='pv-map-canvas'></div>"),void 0==a.MapService||"openstreetmap"!=a.MapService.toLowerCase())this.APIKey=void 0!=a.GoogleAPIKey?a.GoogleAPIKey:"AIzaSyAnPWLPKMYKQZa2g1p11d_vllwwT7CFdQg",this.mapService="google",PivotViewer.Utils.loadScript("lib/wicket/wicket-gmap3.min.js"),"Google"==a.GeocodeService?this.geocodeService="Google":GeocodeService="Nominatim";else{this.mapService="openstreetmap",this.geocodeService="Nominatim",PivotViewer.Utils.loadScript("lib/wicket/wicket-leaflet.min.js"),this.map=new L.Map(document.getElementById("pv-map-canvas"));var b="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",c="Map data Â© OpenStreetMap contributors";this.osm=new L.TileLayer(b,{attribution:c}),this.map.addLayer(this.osm),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Red.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Yellow.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreen.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Blue.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Purple.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Orange.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Pink.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Sky.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Lime.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Gold.png"}})),this.icons.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/Green.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/RedDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/YellowDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/DarkGreenDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/BlueDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PurpleDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/OrangeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/PinkDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/SkyDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/LimeDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GoldDot.png"}})),this.iconsSelected.push(L.Icon.Default.extend({options:{iconUrl:"lib/leaflet/images/GreenDot.png"}}));var d=this;this.map.on("zoomend",function(a){$.publish("/PivotViewer/Views/Item/Updated",null),d.getOverlay()}),this.map.on("moveend",function(a){$.publish("/PivotViewer/Views/Item/Updated",null),d.getOverlay()}),this.clearMarkers=function(){for(var a=0;a<this.tiles.length;a++){var b=this.tiles[a].marker;void 0!=b&&this.map.removeLayer(b)}},this.selectMarker=function(a){var b=d.getBucketNumber(a);if(a.marker==d.selectedMarker)a.marker.setIcon(new d.icons[b]),d.selected=null,d.selectedMarker.setZIndexOffset(0),d.selectedMarker=null,d.selectedBucket=-1,$(".pv-toolbarpanel-info").empty(),$(".pv-altinfopanel").fadeIn();else{a.marker.setIcon(new d.iconsSelected[b]),a.marker.setZIndexOffset(1e9),d.selected=a,null!=d.selectedMarker&&(d.selectedMarker.setIcon(new d.icons[d.selectedBucket]),d.selectedMarker.setZIndexOffset(0)),d.selectedMarker=a.marker,d.selectedBucket=b,d.map.panTo(a.loc),$(".pv-toolbarpanel-info").empty();var c="<img style='height:15px;width:auto' src='"+a.marker._icon.src+"'></img>";c+=d.buckets[b].startRange==d.buckets[b].endRange?d.buckets[b].startRange:d.buckets[b].startRange+" to "+d.buckets[b].endRange,$(".pv-toolbarpanel-info").append(c),$(".pv-altinfopanel").hide()}},this.newMarker=function(a){return a.marker=new L.Marker(a.loc,{title:a.item.name}),this.map.addLayer(a.marker),a.marker.setIcon(new this.icons[this.buckets.ids[a.item.id]]),a.marker.on("click",function(a){return function(){$.publish("/PivotViewer/Views/Item/Selected",[{item:a}])}}(a)),marker},this.refitBounds=function(){var a=[];for(i=0;i<this.filterList.length;i++){var b=this.filterList[i];void 0!=b.marker&&a.push(b.marker.getLatLng())}var c=new L.LatLngBounds(a);this.map.fitBounds(c)},this.getOverlay=function(){var a=this.map.getBounds(),b=a.getWest(),c=a.getEast(),d=a.getNorth(),e=a.getSouth(),f=this.map.getSize(),g=f.x,h=f.y;if(null!=this.overlayBaseImageUrl){this.overlay&&this.map.hasLayer(this.overlay)&&this.map.removeLayer(this.overlay);var i=this.overlayBaseImageUrl+"&bbox="+b+","+e+","+c+","+d+"&width="+g+"&height="+h;this.overlay=new L.imageOverlay(i,a,{opacity:.4}),this.overlay.addTo(this.map)}}}void 0!=a.MapOverlay&&(this.overlayBaseImageUrl=a.MapOverlay)},activate:function(){Modernizr.canvas&&("google"==this.mapService&&null==this.map?PivotViewer.Utils.loadScript("https://maps.googleapis.com/maps/api/js?key="+this.APIKey+"&sensor=false&callback=mapView.apiLoaded"):this._super(),$(".pv-toolbarpanel-info").fadeIn(),$(".pv-altinfopanel").fadeIn(),$(".pv-toolbarpanel-zoomcontrols").hide(),$(".pv-toolbarpanel-zoomcontrols").css("border-width","0"),$("#MAIN_BODY").css("overflow","auto"),$(".pv-mapview-canvas").fadeIn(),$(".pv-toolbarpanel-sort").fadeIn(),null!=this.map&&this.refitBounds())},deactivate:function(){this._super(),$(".pv-altinfopanel").fadeOut(),$(".pv-toolbarpanel-info").fadeOut(),$(".pv-mapview-canvas").fadeOut(),$(".pv-toolbarpanel-sort").fadeOut()},getBucketNumber:function(a){var b=this.buckets.ids[a.item.id];return void 0!=b?b:-1},bucketize:function(a,b,c){if(category=PivotCollection.getCategoryByName(c),void 0==b[0].item.getFacetByName(c))return[{startRange:"(no info)",endRange:"(no info)",tiles:[b[0]],values:["(no info)"],startLabel:"(no info)",endLabel:"(no info)"}];for(var d=b[0].item.getFacetByName(c).values[0].value,e=b.length-1;e>0&&void 0==b[e].item.getFacetByName(c);e--);var f=b[e].item.getFacetByName(c).values[0].value;return category.isDateTime()?(d=new Date(d),f=new Date(f),f.getFullYear()-d.getFullYear()+d.getFullYear()%10>9?PivotViewer.Utils.getBuckets(b,c,function(a){var b=new Date(a.value).getFullYear();return b-b%10},function(a){var b=new Date(a.value).getFullYear();return b-b%10+"s"}):f.getFullYear()>d.getFullYear()?PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getFullYear()},function(a){return new Date(a.value).getFullYear().toString()}):f.getMonth()>d.getMonth()?PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getMonth()},function(a){var b=new Date(a.value);return PivotViewer.Utils.getMonthName(b)+" "+b.getFullYear()}):f.getDate()>d.getDate()?PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getDate()},function(a){var b=new Date(a.value);return PivotViewer.Utils.getMonthName(b)+" "+b.getDate()+", "+b.getFullYear()}):f.getHours()>d.getHours()?PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getHours()},function(a){var b=new Date(a.value);return PivotViewer.Utils.getMonthName(b)+" "+b.getDate()+", "+b.getFullYear()+" "+PivotViewer.Utils.getHour(b)+" "+PivotViewer.Utils.getMeridian(b)}):f.getMinutes()>d.getMinutes()?PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getMinutes()},function(a){var b=new Date(a);return PivotViewer.Utils.getMonthName(b)+" "+b.getDate()+", "+b.getFullYear()+" "+PivotViewer.Utils.getHour(b)+":"+b.getMinutes()+" "+PivotViewer.Utils.getMeridian(b)}):PivotViewer.Utils.getBuckets(b,c,function(a){return new Date(a.value).getSeconds()},function(a){var b=new Date(a.value);return PivotViewer.Utils.getMonthName(b)+" "+b.getDate()+", "+b.getFullYear()+" "+PivotViewer.Utils.getHour(b)+":"+b.getMinutes()+"::"+b.getSeconds()+" "+PivotViewer.Utils.getMeridian(b)})):PivotViewer.Utils.getBuckets(b,c)},filter:function(){var b=0;this.buckets=this.bucketize(this.tiles,this.filterList,this.sortCategory),$(".pv-toolbarpanel-info").empty(),null==this.selected&&$(".pv-altinfopanel").fadeIn();for(var c=0;c<PivotCollection.categories.length;c++){var d=PivotCollection.categories[c];if(d.name.toUpperCase().indexOf("GEOMETRY")>=0){for(j=0;j<this.filterList.length;j++){var e=this.filterList[j].item.getFacetByName(d.name);if(void 0!=e){this.geometryValue=e.values[0].value;break}}if(j<this.filterList.length)break}}for(var c=0;c<PivotCollection.categories.length;c++){var d=PivotCollection.categories[c];if(d.name.toUpperCase().indexOf("AREA")>=0)for(j=0;j<this.filterList.length;j++){var e=this.filterList[j].item.getFacetByName(d.name);if(void 0!=e){this.areaValues.push({id:this.filterList[j].item.id,area:e.values[0].value});break}}}for(var d,f=null,g=null,c=0;c<PivotCollection.categories.length;c++){var d=PivotCollection.categories[c],h=d.name.toLowerCase();if(d.isLocation()){0==d.uiInit&&PV.initUICategory(d);break}if(h.indexOf("latitude")>=0?f=d:h.indexOf("longitude")>=0&&(g=d),null!=f&&null!=g){0==f.uiInit&&PV.initUICategory(f),0==g.uiInit&&PV.initUICategory(g);break}}for(var c=0;c<this.filterList.length;c++){var i=this.filterList[c];if((Settings.showMissing||!i.missing)&&void 0==i.loc){var l=null,m=null;if(null!=f&&null!=g){if(l=i.item.getFacetByName(f.name),m=i.item.getFacetByName(g.name),void 0!=l&&void 0!=m){var n=l.values[0].value,o=m.values[0].value;null!=o&&null!=n&&("string"==typeof n&&(n=parseFloat(n)),"string"==typeof o&&(o=parseFloat(o)),isNaN(o)||isNaN(n)||(i.loc=new L.LatLng(n,o)))}}else if(null!=d){var e=i.item.getFacetByName(d.name);if(void 0==e)continue;var p=e.values[0].value;if(0==p.toLowerCase().indexOf("point(")){var o=parseFloat(p.substring(6,p.indexOf(" ",6)-6)),n=parseFloat(p.substring(p.indexOf(" ",6)+1,p.indexOf(")")-(p.indexOf(" ")+1)));isNaN(n)||isNaN(o)||(i.loc=new L.LatLng(n,o))}else if(p.indexOf(",")>-1){var n=parseFloat(p.substring(0,p.indexOf(","))),o=parseFloat(p.substring(p.indexOf(",")));if(isNaN(n)||isNaN(o)){if(p.length>1){var q=p.toUpperCase();if(void 0!=this.locCache[q])i.loc=this.locCache[q];else{var n,o;b<1e3&&(void 0==this.itemsToGeocode[q]&&(this.itemsToGeocode[q]=[],b++),this.itemsToGeocode[q].push(i))}}}else i.loc=new L.LatLng(n,o)}}}}b>0&&this.getLocationsFromNames(),$(".pv-mapview-canvas").css("height",this.height-12+"px"),$(".pv-mapview-canvas").css("width",this.width-415+"px"),this.createMap()},getButtonImage:function(){return"images/MapView.png"},getButtonImageSelected:function(){return"images/MapViewSelected.png"},getViewName:function(){return"Map View"},makeGeocodeCallBack:function(a){var b=this,c=function(c){results=c.results,status=c.status;var d=new L.LatLng(0,0);if(status==google.maps.GeocoderStatus.OK){var e=results[0].geometry.location,f=e.lat,g=e.lng;f&&g&&(d=new L.LatLng(f,g))}b.locCache[a]=d,b.localStorage&&localStorage.setItem(a,JSON.stringify(d));for(var h=0;h<b.itemsToGeocode[a].length;h++)b.itemsToGeocode[a][h].loc=d;delete b.itemsToGeocode[a];var i=new Date;(i.getTime()-b.geocodeZero.getTime())/1e3>20?(b.redrawMarkers(),b.startGeocode=new Date):(i.getTime()-b.startGeocode.getTime())/1e3>2&&(b.redrawMarkers(),b.refitBounds(),b.getOverlay(),b.startGeocode=new Date),0==Object.keys(b.itemsToGeocode).length&&b.createMap()};return c},geocode:function(a,b){var d="http://www.datasciencetoolkit.org/maps/api/geocode/json?sensor=false&address="+encodeURIComponent(a);$.ajax({type:"GET",url:d,dataType:"jsonp",success:function(a){b(a)}})},getLocationsFromNames:function(){for(var a=0;a<Object.keys(this.itemsToGeocode).length;a++){var b=Object.keys(this.itemsToGeocode)[a];this.geocode(b,this.makeGeocodeCallBack(b))}this.startGeocode=new Date,this.startGeocode.setSeconds(this.startGeocode.getSeconds()+2),this.geocodeZero=new Date},createMap:function(){if(null!=this.geometryValue){var a=new Wkt.Wkt;try{a.read(this.geometryValue)}catch(b){try{a.read(this.geometryValue.replace("\n","").replace("\r","").replace("\t",""))}catch(a){"WKTError"===a.name&&Debug.log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters.")}}var b=a.toObject(this.map.defaults);if(Wkt.isArray(b))for(var c=0;c<b.length;c++)this.map.addLayer(b[c]);else this.map.addLayer(b)}this.createMarkers(),this.refitBounds(),this.getOverlay(),this.createLegend()},createMarkers:function(){for(this.clearMarkers&&this.clearMarkers(),i=0;i<this.filterList.length;i++){var a=this.filterList[i];void 0==a.loc||!Settings.showMissing&&a.missing||this.newMarker(a)}},drawArea:function(){var a,b=new Wkt.Wkt;this.areaObj&&this.map.removeLayer(this.areaObj);for(var c=0;c<this.areaValues.length;c++)if(this.areaValues[c].id==this.selected.item.id){a=this.areaValues[c].area;break}if(a){var d=!0;try{b.read(a)}catch(c){try{b.read(a.replace("\n","").replace("\r","").replace("\t",""))}catch(a){"WKTError"===a.name&&(Debug.log("Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters."),d=!1)}}if(d)if(this.areaObj=b.toObject({color:"#990000",fillColor:"#EEFFCC",fillOpacity:.6}),Wkt.isArray(this.areaObj))for(var e=0;e<this.areaObj.length;e++)this.map.addLayer(this.areaObj[e]);else this.map.addLayer(this.areaObj)}},redrawMarkers:function(){this.createMarkers(),this.drawArea()},createLegend:function(){var a=$(".pv-altinfopanel").width()-32;$(".pv-altinfopanel").empty(),$(".pv-altinfopanel").append("<div class='pv-legend-heading' style='height:28px' title='"+this.sortCategory+"'>"+this.sortCategory+"</div>");for(var b="<table id='pv-legend-data' style='color:#484848;'>",c=0;c<this.buckets.length;c++){var d="google"==this.mapService?this.icons[c]:(new this.icons[c]).options.iconUrl;b+="<tr><td><img src='"+d+"'></img></td>",b+=this.buckets[c].startRange==this.buckets[c].endRange?"<td><div style='overflow:hidden;white-space:nowrap;width:"+a+"px;text-overflow:ellipsis'>"+this.buckets[c].startLabel+"</div></td></tr>":"<td><div style='overflow:hidden;white-space:nowrap;width:"+a+"px;text-overflow:ellipsis'>"+this.buckets[c].startLabel+" to "+this.buckets[c].endLabel+"</div></td></tr>"}b+="</table>",$(".pv-altinfopanel").append(b)}});
