PivotViewer.Utils.loadScript("src/views/bucketview.min.js"),PivotViewer.Views.CrosstabView=PivotViewer.Views.BucketView.subClass({init:function(){this._super();var a=this;0==$("#pv-altsortcontrols").length&&($("#pv-primsortcontrols").before("<div id='pv-altsortcontrols' class='pv-toolbarpanel-sortcontrols'></div>"),$("#pv-altsortcontrols").hide(),$("#pv-primsort").clone(!0).attr("id","pv-altsort").appendTo($("#pv-altsortcontrols")),1==_options.authoring&&PV.getGraphParameters(),$("#pv-altsort").on("change",function(b){if(void 0!=a.bucketsY){a.sortCategory2=$("#pv-altsort option:selected").html(),1==_options.authoring&&(PARA.y_axis=a.sortCategory2);var c=PivotCollection.getCategoryByName(a.sortCategory2);c.uiInit||PV.initUICategory(c);var d=a.filterList.slice(0).sort(tileSortBy(a.sortCategory2));if(Settings.showMissing)a.filterList2=d;else{a.filterList2=[];for(var e=0;e<d.length;e++){var f=d[e];void 0!=f.item.getFacetByName(a.sortCategory2)&&a.filterList2.push(f)}}a.bucketsY=a.bucketize(a.filterList2,a.sortCategory2),a.subbucketize(),1==_options.authoring&&PV.getGraphParameters(),a.activate()}}))},getBucket:function(a){return Math.floor((a-this.offsetX-this.columnWidth)/this.columnWidth)},getBucketY:function(a){return this.bucketsY.length-Math.floor(a/this.rowHeight)-1},recalibrateUISettings:function(){this.rowscols=this.getTileDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount,this.rowscols)},resetUISettings:function(){this.rowscols=this.calculateDimensions((this.origColumnWidth-4)*this.scale,(this.rowHeight-4)*this.scale,this.maxRatio,this.bigCount)},subbucketize:function(){for(var a=0;a<this.buckets.length;a++){var b=this.buckets[a];b.subBuckets=[],b.colCount=0;for(var c=0;c<this.bucketsY.length;c++){var d=this.bucketsY[c];b.subBuckets.push(new PivotViewer.Models.Bucket(d.startRange,d.startLabel,d.endRange,d.endLabel))}}for(var a=0;a<this.filterList.length;a++){var e=this.filterList[a],f=e.item.id,g=this.buckets.ids[f],h=this.bucketsY.ids[f];if(void 0!=g&&void 0!=h){g instanceof Array||(g=[g]),h instanceof Array||(h=[h]);for(var i=0;i<g.length;i++)for(var j=0;j<h.length;j++)this.buckets[g[i]].subBuckets[h[j]].addTile(e),this.buckets[g[i]].colCount++}}},filterY:function(){if(void 0==this.bucketsY)this.sortCategory2=$("#pv-primsort option:selected").html(),$("#pv-altsort").val($("#pv-primsort").val()),this.bucketsY=this.buckets,this.filterList2=this.filterList;else{var a=[];if(this.filterList.length<this.oldFilterList.length)for(var b=0;b<this.filterList2.length;b++){var c=this.filterList2[b];void 0!=this.buckets.ids[c.item.id]&&a.push(c)}else{for(var d=[],e=PivotCollection.getCategoryByName(this.sortCategory2),b=0;b<this.filterList.length;b++){var c=this.filterList[b];void 0!=this.bucketsY.ids[c.item.id]||!Settings.showMissing&&void 0==c.item.getFacetByName(this.sortCategory2)||d.push(c)}d.sort(tileSortBy(this.sortCategory2));for(var b=0,f=0;b<this.filterList2.length&&f<d.length;){var i,j,g=this.filterList2[b],h=d[f],k=g.item.getFacetByName(this.sortCategory2),l=h.item.getFacetByName(this.sortCategory2);void 0!=k?void 0!=l?(e.isDateTime()?(i=new Date(k.values[0].value),j=new Date(l.values[0].value)):(i=k.values[0].value,j=l.values[0].value),i<j?(a.push(g),b++):(a.push(h),f++)):(a.push(g),b++):(a.push(h),f++)}for(;b<this.filterList2.length;)a.push(this.filterList2[b++]);for(;f<d.length;)a.push(d[f++])}this.filterList2=a,"db"==$(".pv-facet[facet='"+PV.cleanName(this.sortCategory2).toLowerCase()+"']").attr("mode")?(this.bucketsY=DB.getBuckets(this.sortCategory2),PivotViewer.Utils.fillBuckets(this.bucketsY,this.filterList2,this.sortCategory2)):this.bucketsY=this.bucketize(this.filterList2,this.sortCategory2)}this.subbucketize()},filter:function(){this.buckets=this.bucketize(this.filterList,this.sortCategory),this.filterY()},createUI:function(){$("#pv-altsortcontrols").show(),this.columnWidth=this.origColumnWidth=(this.width-this.offsetX)/(this.buckets.length+1),this.canvasHeightUIAdjusted=this.height-this.offsetY-this.titleSpace,this.rowHeight=this.canvasHeightUIAdjusted/this.buckets[0].subBuckets.length;var a="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; height:"+this.height+"px;''>";this.bigCount=0;for(var b=0;b<this.bucketsY.length;b++){var c=this.bucketsY[b],d=c.startRange==c.endRange||c.startLabel==c.endLabel?d=c.startLabel:c.startLabel+" to "+c.endLabel;a+="<div class='pv-bucketview-overlay-buckettitle-left' style='top: "+(this.bucketsY.length-1-b)*this.rowHeight+"px; height: "+(this.rowHeight-4)+"px; width: "+(this.columnWidth-4)+"px'><div class='pv-bucket-countbox'>"+this.bucketsY[b].tiles.length+"<br>"+Math.round(this.bucketsY[b].tiles.length/this.filterList2.length*100)+"%</div><div class='pv-bucket-label'>"+d+"</div></div>"}a+=this.getStatsBox()+"</div>";for(var b=0;b<this.buckets.length;b++){var c=this.buckets[b];a+="<div class='pv-bucketview-overlay-bucket' style='width: "+(this.columnWidth-4)+"px; left:"+(b+1)*this.columnWidth+"px; height:"+this.height+"px;'>";for(var e=c.subBuckets.length-1;e>=0;e--){var f=c.subBuckets[e],g=b%2==e%2?"bucketview-bucket-dark":"bucketview-bucket-light";(f.equals(PV.subsets[0])||f.equals(PV.subsets[1]))&&(g+=" pv-bucketview-subset"),a+="<div style='height:"+this.rowHeight+"px; top:"+e*this.rowHeight+"px;'><div class='pv-crosstabview-overlay-bucket "+g+"' style='height:"+(this.rowHeight-4)+"px; top: "+e*this.rowHeight+"px;'></div></div>",this.bigCount<f.tiles.length&&(this.bigCount=f.tiles.length)}var d=c.startRange==c.endRange||c.startLabel==c.endLabel?d="<div class='pv-bucket-label'>"+c.startLabel+"</div>":c.startLabel+"<br>to<br>"+c.endLabel;a+="<div class='pv-bucketview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"';'><div class='pv-bucket-countbox'>"+this.buckets[b].colCount+"<br>"+Math.round(this.buckets[b].colCount/this.filterList2.length*100)+"%</div>"+d+"</div></div></div>"}$(".pv-viewpanel-view").append("<div class='pv-bucketview-overlay'></div>"),$(".pv-bucketview-overlay").css("left",this.offsetX+"px").append(a),$(".pv-bucketview-overlay div").fadeIn("slow");for(var b=0;b<this.tiles.length;b++){var h=this.tiles[b],i=h._locations[0];if(i.startx=i.x,i.starty=i.y,h.startwidth=h.width,h.startheight=h.height,!h.filtered||!Settings.showMissing&&h.missing){h.start=PivotViewer.Utils.now(),h.end=h.start+1e3;var j=Math.atan2(i.y-this.currentHeight/2,i.x-this.currentWidth/2);i.destinationx=this.currentWidth*Math.cos(j)+this.currentWidth/2,i.destinationy=this.currentHeight*Math.sin(j)+this.currentHeight/2}}this.maxRatio=TileController._imageController.getRatio(this.tiles[0].item.img);for(var b=0;b<this.filterList.length;b++){var k=TileController._imageController.getRatio(this.filterList[b].item.img);k<this.maxRatio&&(this.maxRatio=k)}var l=this.filterList.length==this.tiles.length?0:500,m=this;setTimeout(function(){var a=$(".pv-toolbarpanel-zoomslider").slider("option","value");a>0&&(m.selected=selectedTile=null,m.currentOffsetX=m.offsetX,m.currentOffsetY=m.offsetY,m.resetUISettings(),PV.zoom(0)),m.resetUISettings();for(var b=TileController._imageController,c=0;c<m.tiles.length;c++)m.tiles[c].origwidth=m.rowscols.TileHeight/b.getRatio(m.tiles[c].item.img),m.tiles[c].origheight=m.rowscols.TileHeight,m.tiles[c].destinationwidth=1,m.tiles[c].destinationheight=1;m.setTilePositions(m.rowscols,m.offsetX,m.offsetY,!1,!1)},l)},deactivate:function(){this._super(),$("#pv-altsortcontrols").hide()},getButtonImage:function(){return"images/CrossTabView.png"},getButtonImageSelected:function(){return"images/CrossTabViewSelected.png"},getViewName:function(){return"Crosstab View"},setTilePositions:function(a,b,c,d,e){var f=e&&this.rowscols?this.rowscols.Columns:a.Columns;e||(this.rowscols=a);for(var i=0;i<this.tiles.length;i++)this.tiles[i].firstFilterItemDone=!1,this.tiles[i]._locations=[this.tiles[i]._locations[0]];for(var j=this.rowHeight*this.scale,k=0;k<this.buckets.length;k++)for(var l=this.buckets[k],m=0;m<l.subBuckets.length;m++)for(var n=l.subBuckets[m],o=0,p=0,q=0;q<n.tiles.length;q++){var r=n.tiles[q];if(r.firstFilterItemDone){var s=new PivotViewer.Views.TileLocation;s.startx=r._locations[0].startx,s.starty=r._locations[0].starty,s.x=r._locations[0].x,s.y=r._locations[0].y,s.destinationx=(k+1)*this.columnWidth+o*a.TileMaxWidth+b,s.destinationy=this.canvasHeightUIAdjusted-m*j-a.TileHeight-p*a.TileHeight+c-10,r._locations.push(s)}else{var s=r._locations[0];d&&(s.startx=s.x,s.starty=s.y,r.startwidth=r.width,r.startheight=r.height),r.destinationwidth=a.TileMaxWidth,r.destinationheight=a.TileHeight,s.destinationx=(k+1)*this.columnWidth+o*a.TileMaxWidth+b,s.destinationy=this.canvasHeightUIAdjusted-m*j-a.TileHeight-p*a.TileHeight+c-10,r.start=PivotViewer.Utils.now(),r.end=r.start+1e3,r.firstFilterItemDone=!0}o==f-1?(o=0,p++):o++}},centerOnTile:function(a){var h,i,b=a._locations[a.selectedLoc],c=a.item,d=this.rowscols.Columns,e=this.rowscols.Rows,f=this.rowscols.TileMaxWidth,g=this.rowscols.TileHeight;h=this.buckets.ids[c.id]instanceof Array?this.buckets.ids[c.id][a.cellLoc[0]]:this.buckets.ids[c.id],i=this.bucketsY.ids[c.id]instanceof Array?this.bucketsY.ids[c.id][a.cellLoc[1]]:this.bucketsY.ids[c.id];for(var j=Math.round((b.x-this.currentOffsetX-(h+1)*this.columnWidth)/f),k=e-Math.floor((b.y-this.currentOffsetY-(this.bucketsY.length-i-1)*this.rowHeight*this.scale-this.rowscols.PaddingY)/g),l=this.buckets[h].subBuckets[i],m=k*d+j;(m>l.tiles.length||l.tiles[m]!=a)&&m>=0;)k--,m-=d;var p,n=a.context.canvas.height,o=a.context.canvas.width-($(".pv-filterpanel").width()+$(".pv-infopanel").width());p=a.height/n>a.height/TileController._imageController.getRatio(c.img)/o?a.origheight/n:a.origwidth/o,null==this.selected&&PV.zoom(Math.round(.75/p*2)),this.currentOffsetX=this.width/2-this.rowscols.TileMaxWidth/2-(h+1)*this.columnWidth-j*this.rowscols.TileMaxWidth,this.currentOffsetY=this.height/2-this.canvasHeightUIAdjusted+this.rowscols.TileHeight/2+i*this.rowHeight*this.scale+k*this.rowscols.TileHeight+10,this.setTilePositions(this.rowscols,this.currentOffsetX,this.currentOffsetY,!0,!0)},getStatsBox:function(){for(var b,a=0,c=0;c<this.buckets.length;c++)if(b=this.buckets[c],0!=b.tiles.length)for(var d=0;d<this.bucketsY.length;d++){var e=this.bucketsY[d];if(0!=e.tiles.length){var f=b.tiles.length*e.tiles.length/this.filterList.length,g=f-b.subBuckets[d].tiles.length;a+=g*g/f}}a=Math.floor(100*a)/100;var h=pochisq(a,this.buckets.length,b.subBuckets.length),i="";return h<.001?i="***":h<.01?i="**":h<.05&&(i="*"),"<div class='pv-crosstabview-overlay-statsbox' style='position:absolute; width: "+(this.columnWidth-4)+"px; height: 50px; top: "+this.bucketsY.length*this.rowHeight+"px;'><div style='text-align:center'>"+this.sortCategory2+"</div><div class='pv-bucket-countbox' title='chi-squared'>X<sup>2</sup><br>"+a+i+"</div><div style='position:absolute; right:2px;'>"+this.sortCategory+"</div></div>"},handleHover:function(a){if(null==this.selected){for(var b=0;b<this.buckets.length;b++)for(var c=0;c<this.buckets[b].tiles.length;c++){var d=this.buckets[b].tiles[c].contains(a.x,a.y);if(d>=0){for(var f,g,e=this.buckets[b].tiles[c].item.facets,h=0;h<e.length;h++)e[h].name==this.sortCategory2&&(f=d%e[h].values.length,g=Math.floor(d/e[h].values.length));this.buckets[b].tiles[c].setSelected(!0,d,[g,f])}else this.buckets[b].tiles[c].setSelected((!1).null)}if($(".pv-crosstabview-overlay-bucket").removeClass("bucketview-bucket-hover"),$(".pv-tooltip").remove(),!(this.scale>1)){var i=this.getBucket(a.x),j=this.getBucketY(a.y);if(i>=0&&j>=0)return void $(".pv-crosstabview-overlay-bucket").eq(i*this.bucketsY.length+(this.bucketsY.length-j-1)).addClass("bucketview-bucket-hover");var k,l,m,n;if(!(i<-1||j<-1)){if(i==-1){if(j==-1)return $(".pv-bucketview-overlay").append("<div class='pv-tooltip'>chi-squared</div>"),void $(".pv-tooltip").offset($(".pv-crosstabview-overlay-statsbox").offset());m=j,k=$(".pv-bucketview-overlay-buckettitle-left").eq(m),l=this.bucketsY[m],n=this.sortCategory2}else{if(j!=-1)return;m=i,k=$(".pv-bucketview-overlay-buckettitle").eq(m),l=this.buckets[m],n=this.sortCategory}var p=PivotCollection.getCategoryByName(n).isString(),q="<div class='pv-tooltip'>"+n+" Bucket "+(m+1)+":<br>"+(l.startLabel==l.endLabel?" Value: "+(p?'"':"")+l.startLabel+(p?'"':"")+"<br>":"Values: from "+(p?'"':"")+l.startLabel+(p?'"':"")+"  to "+(p?'"':"")+l.endLabel+(p?'"':"")+"<br>")+l.tiles.length+" of "+this.filterList2.length+" items ("+Math.round(l.tiles.length/this.filterList2.length*100)+"%)"+(Settings.showMissing?"</div>":"<br><i>(Some items may be missing values for this variable.)</i></div>");$(".pv-bucketview-overlay").append(q),$(".pv-tooltip").offset(k.offset())}}}},handleClick:function(a){if(this.hasSubsets()&&!PV.subsets.finalized)return PV.subsets.finalized=!0,void PV.filterViews();var b=this.super_handleClick(a);if("init"==a.type&&(this.resetUISettings(),(this.buckets.ids[b.item.id]instanceof Array||this.bucketsY.ids[b.item.id]instanceof Array)&&null==b.cellLoc)){b.selectedLoc=PARA.selected_loc;for(var c=b.item.facets,d=0;d<c.length;d++)if(c[d].name==this.sortCategory2){var e=b.selectedLoc%c[d].values.length,f=Math.floor(b.selectedLoc/c[d].values.length);b.cellLoc=[f,e]}}if(null!=this.selected&&this.selected.setSelected(!1),null!=b)this.selected!=b?(1==_options.authoring&&(PARA.selected_loc=b.selectedLoc),b.setSelected(!0,null),this.centerOnTile(b),this.setSelected(b),$(".pv-bucketview-overlay div").fadeOut("slow")):(b=null,this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow"));else{this.setSelected(null),PV.zoom(0),$(".pv-bucketview-overlay div").fadeIn("slow");var g=this.getBucket(a.x),h=this.getBucketY(a.y);if(g>=0){var i=this.buckets[g];if(h>=0){var j=this.bucketsY[h];$.publish("/PivotViewer/Views/Item/Filtered",[[{category:this.sortCategory,min:i.startRange,max:i.endRange,values:i.values},{category:this.sortCategory2,min:j.startRange,max:j.endRange,values:j.values}]])}else $.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory,min:i.startRange,max:i.endRange,values:i.values}])}else if(h>=0){var j=this.bucketsY[h];$.publish("/PivotViewer/Views/Item/Filtered",[{category:this.sortCategory2,min:j.startRange,max:j.endRange,values:j.values}])}}$.publish("/PivotViewer/Views/Item/Selected",[{item:b}])},handleContextMenu:function(a){var b=this.getBucket(a.x),c=this.getBucketY(a.y),d=$(".pv-crosstabview-overlay-bucket").eq(b*this.bucketsY.length+(this.bucketsY.length-c-1));this.addSubset(this.buckets[b].subBuckets[c])?d.addClass("pv-bucketview-subset"):d.removeClass("pv-bucketview-subset")}});
